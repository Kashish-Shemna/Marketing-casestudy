# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/15NtM443Gmpvkk4E7A6fCydhvcfT11jfM
"""

import streamlit as st
import pandas as pd
import pickle
import statsmodels.api as sm

# ----------------- LOAD PICKLE -----------------
with open("model_with_clusters.pkl", "rb") as f:
    artifacts = pickle.load(f)

clf_model = artifacts["classification_model"]
class_feature_names = artifacts["class_feature_names"]

cluster_model = artifacts["cluster_model"]
cluster_feature_names = artifacts["cluster_feature_names"]
cluster_summary = artifacts["cluster_summary"]

# infer cluster label column name (e.g. 'cluster_label')
cluster_label_col = cluster_summary.columns[0]  # first column is cluster id

# ----------------- STREAMLIT UI -----------------
st.title("ðŸ“Š Response Prediction & Cluster Highlight Dashboard")

st.write(
    """
    This app:
    - Predicts **Yes/No response** for a record
    - Assigns it to a **cluster**
    - Shows how that cluster behaves in terms of **Yes/No rate**
    """
)

st.subheader("Enter Feature Values")

# We'll take inputs for ALL features used in either model
all_features = sorted(set(class_feature_names) | set(cluster_feature_names))

user_inputs = {}
for feat in all_features:
    # Numeric inputs (you can later customize based on feature type if needed)
    user_inputs[feat] = st.number_input(feat, value=0.0)

if st.button("Predict & Show Cluster Insights"):
    # ------------- PREPARE INPUT FOR CLASSIFICATION -------------
    class_input_row = [user_inputs[feat] for feat in class_feature_names]
    class_input_df = pd.DataFrame([class_input_row], columns=class_feature_names)

    # add constant term for statsmodels
    class_input_df_const = sm.add_constant(class_input_df, has_constant="add")

    # predicted probability of response = 1 (Yes)
    prob_yes = float(clf_model.predict(class_input_df_const)[0])
    pred_label = 1 if prob_yes >= 0.5 else 0

    # ------------- PREPARE INPUT FOR CLUSTERING -------------
    cluster_input_row = [user_inputs[feat] for feat in cluster_feature_names]
    cluster_input_df = pd.DataFrame([cluster_input_row], columns=cluster_feature_names)

    cluster_id = int(cluster_model.predict(cluster_input_df.values)[0])

    # get this cluster's summary row
    row = cluster_summary[cluster_summary[cluster_label_col] == cluster_id]

    if row.empty:
        st.warning("Cluster not found in summary table.")
    else:
        row = row.iloc[0]
        cluster_size = int(row["count"])
        yes_rate = float(row["response_yes_rate"])  # 0â€“1

        # ------------- SHOW PREDICTION -------------
        st.subheader("Prediction Result")

        if pred_label == 1:
            st.success(
                f"âœ… **Predicted Response: YES**  \n"
                f"Estimated probability of YES: `{prob_yes:.2f}`"
            )
        else:
            st.error(
                f"âŒ **Predicted Response: NO**  \n"
                f"Estimated probability of YES: `{prob_yes:.2f}`"
            )

        # ------------- SHOW CLUSTER INFO & HIGHLIGHT -------------
        st.subheader("Cluster Behaviour")

        st.write(f"You fall into **Cluster {cluster_id}**.")

        # Color logic based on Yes rate
        if yes_rate >= 0.7:
            st.success(
                f"ðŸŸ¢ This is a **YES-dominant cluster** "
                f"(Yes rate: `{yes_rate:.2f}`, Records: `{cluster_size}`)"
            )
        elif yes_rate <= 0.3:
            st.error(
                f"ðŸ”´ This is a **NO-dominant cluster** "
                f"(Yes rate: `{yes_rate:.2f}`, Records: `{cluster_size}`)"
            )
        else:
            st.warning(
                f"ðŸŸ¡ This cluster is **mixed** "
                f"(Yes rate: `{yes_rate:.2f}`, Records: `{cluster_size}`)"
            )

        # Show full cluster summary table below
        with st.expander("See full cluster-wise Yes/No behaviour"):
            st.dataframe(cluster_summary)